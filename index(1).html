<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Kids Reading Coach - DRA Level 1 Starter</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 900px; margin: 20px auto; padding: 20px; background: #f9f9f9; }
    h1 { color: #2c3e50; text-align: center; }
    #passage { font-size: 1.4em; line-height: 1.5; background: white; padding: 20px; border: 1px solid #ddd; border-radius: 8px; margin: 20px 0; white-space: pre-wrap; }
    #transcript { font-size: 1.2em; min-height: 60px; padding: 15px; background: #e8f4fd; border: 1px dashed #3498db; border-radius: 8px; margin: 15px 0; }
    button { font-size: 1.1em; padding: 12px 24px; margin: 8px; cursor: pointer; border: none; border-radius: 6px; }
    #start { background: #27ae60; color: white; }
    #stop { background: #e74c3c; color: white; }
    #next { background: #f39c12; color: white; }
    #status { font-weight: bold; font-size: 1.2em; color: #34495e; text-align: center; margin: 15px 0; }
    .correct { color: green; }
    .error { color: red; text-decoration: underline; }
  </style>
</head>
<body>

<h1>Kids Reading Coach - Easy Starter (DRA ~1â€“4)</h1>
<p style="text-align:center;">Read the passage out loud clearly. The app will listen, transcribe, and tell you your accuracy.<br>
You need <strong>â‰¥90% accuracy</strong> on <strong>two passages in a row</strong> to move to the next one!</p>

<div id="status">Ready to start? Click "Start Listening"</div>

<div id="passage"></div>

<button id="start">Start Listening ðŸŽ¤</button>
<button id="stop" disabled>Stop Listening</button>
<button id="next" disabled>Next Passage â†’</button>

<div id="transcript">Your spoken words will appear here...</div>

<div id="result"></div>

<script>
// Simple passages â€“ short, meaningful stories with some "trick" words (sight words or common misreads)
const passages = [
  {
    text: "The cat sat on the mat. The mat was red. The cat was big and fat. It was a very happy cat.",
    trickWords: ["sat", "mat", "fat", "happy"] // emphasis on short vowels / sight words
  },
  {
    text: "Sam and Jen run to the big tree. They see a red ball in the tree. Sam jumps up. Jen claps. The ball falls down. They laugh and play.",
    trickWords: ["run", "tree", "jumps", "claps", "laugh"]
  },
  {
    text: "A little dog likes to dig. He digs in the soft sand. He finds a shiny bone. The dog wags his tail. He is so glad!",
    trickWords: ["dig", "digs", "soft", "shiny", "wags", "glad"]
  },
  {
    text: "Mom and Dad go to the shop. They buy milk, bread, and jam. I help put the food away. We all eat lunch together.",
    trickWords: ["shop", "buy", "bread", "jam", "together"]
  }
  // You can add many more here as needed
];

let currentLevel = 0;
let consecutiveGood = 0;
let recognition = null;
let currentPassageText = "";
let currentPassageLowerWords = [];

const passageEl = document.getElementById("passage");
const transcriptEl = document.getElementById("transcript");
const statusEl = document.getElementById("status");
const resultEl = document.getElementById("result");
const startBtn = document.getElementById("start");
const stopBtn = document.getElementById("stop");
const nextBtn = document.getElementById("next");

// Initialize SpeechRecognition (works in Chrome/Edge)
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

if (!SpeechRecognition) {
  statusEl.textContent = "Sorry â€” your browser does not support speech recognition. Try Chrome.";
  startBtn.disabled = true;
} else {
  recognition = new SpeechRecognition();
  recognition.continuous = true;       // keep listening
  recognition.interimResults = true;   // show partial results
  recognition.lang = "en-US";          // change to "en-GB" etc. if needed

  recognition.onresult = (event) => {
    let interim = "";
    let final = "";

    for (let i = event.resultIndex; i < event.results.length; i++) {
      const transcript = event.results[i][0].transcript;
      if (event.results[i].isFinal) {
        final += transcript + " ";
      } else {
        interim += transcript + " ";
      }
    }

    transcriptEl.innerHTML = final + '<span style="color:#888;">' + interim + '</span>';
  };

  recognition.onend = () => {
    startBtn.disabled = false;
    stopBtn.disabled = true;
    statusEl.textContent = "Stopped listening.";
  };

  recognition.onerror = (event) => {
    statusEl.textContent = "Error: " + event.error;
    startBtn.disabled = false;
    stopBtn.disabled = true;
  };
}

function loadPassage() {
  if (currentLevel >= passages.length) {
    passageEl.textContent = "Great job! You've finished all the starter passages. ðŸŽ‰ Want more? Add them in the code!";
    startBtn.disabled = true;
    return;
  }

  const passage = passages[currentLevel];
  currentPassageText = passage.text;
  currentPassageLowerWords = passage.text.toLowerCase()
    .replace(/[.,!?;:'"]/g, " ")   // remove punctuation
    .split(/\s+/)
    .filter(w => w.length > 0);

  passageEl.innerHTML = currentPassageText.replace(
    new RegExp(`\\b(${passage.trickWords.join("|")})\\b`, "gi"),
    '<strong style="color:#e67e22;">$1</strong>'
  ); // highlight trick words lightly

  statusEl.textContent = `Passage ${currentLevel + 1} â€” Read aloud clearly!`;
  transcriptEl.textContent = "";
  resultEl.textContent = "";
  nextBtn.disabled = true;
}

function calculateAccuracy(transcript) {
  if (!transcript.trim()) return 0;

  const spokenWords = transcript.toLowerCase()
    .replace(/[.,!?;:'"]/g, " ")
    .split(/\s+/)
    .filter(w => w.length > 0);

  if (spokenWords.length === 0) return 0;

  let correct = 0;
  let i = 0, j = 0;

  // Simple word-by-word matching (allows some skipping/insertions)
  while (i < spokenWords.length && j < currentPassageLowerWords.length) {
    if (spokenWords[i] === currentPassageLowerWords[j]) {
      correct++;
      i++;
      j++;
    } else {
      i++; // skip extra words in speech
    }
  }

  return Math.round((correct / currentPassageLowerWords.length) * 100);
}

startBtn.onclick = () => {
  if (!recognition) return;
  recognition.start();
  startBtn.disabled = true;
  stopBtn.disabled = false;
  statusEl.textContent = "Listening... Read the passage now!";
};

stopBtn.onclick = () => {
  if (!recognition) return;
  recognition.stop();
};

recognition.onresult = (event) => {
  // ... (already set above)
  // But we can also check final results when user stops
};

recognition.onend = () => {
  startBtn.disabled = false;
  stopBtn.disabled = true;

  // When stopped, calculate accuracy from final transcript
  const spoken = transcriptEl.textContent.replace(/<[^>]+>/g, "").trim(); // strip interim span
  if (spoken) {
    const accuracy = calculateAccuracy(spoken);
    resultEl.innerHTML = `Accuracy: <strong>${accuracy}%</strong>`;

    if (accuracy >= 90) {
      consecutiveGood++;
      resultEl.innerHTML += ' <span style="color:green;">â†’ Great reading!</span>';
      if (consecutiveGood >= 2) {
        statusEl.textContent = "Awesome! Two good reads in a row â†’ advancing...";
        consecutiveGood = 0;
        currentLevel++;
        setTimeout(loadPassage, 2000);
      } else {
        statusEl.textContent = `Good! One more good read to advance. (${consecutiveGood}/2)`;
      }
    } else {
      consecutiveGood = 0;
      resultEl.innerHTML += ' <span style="color:red;">â†’ Try again! Practice the highlighted words.</span>';
      statusEl.textContent = `Accuracy was ${accuracy}%. Let's try the same passage again.`;
    }
  }
};

nextBtn.onclick = () => {
  currentLevel++;
  consecutiveGood = 0;
  loadPassage();
};

// Start with first passage
loadPassage();

</script>
</body>
</html>
