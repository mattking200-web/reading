<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Easy Reading Listener - Progressive DRA Levels</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 700px;
      margin: 30px auto;
      padding: 20px;
      background: #f9f9f9;
      text-align: center;
    }
    h1 { color: #2c3e50; }
    #level-info {
      font-size: 1.4em;
      font-weight: bold;
      margin: 15px 0;
      color: #3498db;
    }
    #passage {
      font-size: 1.6em;
      line-height: 1.5;
      background: white;
      padding: 25px;
      border: 2px solid #ddd;
      border-radius: 12px;
      margin: 25px 0;
      min-height: 120px;
    }
    #transcript {
      font-size: 1.3em;
      color: #555;
      margin: 20px 0;
      min-height: 60px;
    }
    #feedback {
      font-size: 1.4em;
      line-height: 1.5;
      margin: 20px 0;
      padding: 15px;
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 8px;
    }
    #accuracy {
      font-size: 1.8em;
      font-weight: bold;
      margin: 15px 0;
    }
    button {
      font-size: 1.3em;
      padding: 12px 30px;
      margin: 10px;
      cursor: pointer;
      border: none;
      border-radius: 8px;
      background: #3498db;
      color: white;
    }
    button:hover { background: #2980b9; }
    #start { background: #27ae60; }
    #start:hover { background: #219653; }
    #stop { background: #e74c3c; }
    #stop:hover { background: #c0392b; }
    .success { color: #27ae60; }
    .error { color: #e74c3c; }
    #status { font-size: 1.2em; margin: 15px 0; font-weight: bold; }
    .correct { color: #27ae60; font-weight: bold; }
    .incorrect { color: #e74c3c; text-decoration: line-through; }
    .inserted { color: #f39c12; font-style: italic; }
  </style>
</head>
<body>

  <h1>Easy Reading Listener</h1>
  <p>Read the passage out loud clearly. The app will listen, show what you said with colors (green=correct, red=wrong/missing, orange=extra), and tell you how accurate you were! Advance after one great read (90%+). Higher levels have more passages and trickier words.</p>

  <div id="level-info"></div>
  <div id="passage"></div>
  <div id="transcript">Your reading will appear here...</div>
  <div id="feedback">Word feedback will show here after reading.</div>
  <div id="accuracy"></div>
  <div id="status">Ready to start!</div>

  <button id="start">Start Listening ðŸŽ¤</button>
  <button id="stop">Stop Listening</button>

  <script>
    // === Levels with Stories: Each level is a connected story broken into passages. Higher levels have more passages, longer sentences, and trickier words (e.g., sight words like "said", "was", "they", "because", irregulars like "friend") ===
    const levels = [
      // Level 1 (DRA ~1-4): 4 passages, very simple, short sentences, basic sight words.
      [
        "The cat sat on the mat. The cat was fat. He said, 'Meow!'",
        "Sam saw the cat. Sam ran to the van. 'Look!' said Sam.",
        "The dog was big. The dog can dig. Dig, dog!",
        "Mom said, 'Come here.' They said, 'Yes.' The cat was happy."
      ],
      // Level 2 (DRA ~6-8): 5 passages, slightly longer, more repetition of tricky words like "they", "said".
      [
        "The farm has a pig. The pig was in the pen. The pen was red. 'Oink!' said the pig.",
        "They went to the lake. They like to swim. The dog was with them. He said, 'Woof!'",
        "Tim has a hat. The hat was blue. He put it on his head. 'Look at me!' said Tim.",
        "The sun was hot today. They sat by the tree. The tree was big and green.",
        "All the friends play. They run and jump. 'This is fun!' they said together."
      ],
      // Level 3 (DRA ~10-12): 6 passages, more narrative, words like "because", "friend".
      [
        "Anna has a friend. Her friend is Ben. They like to play ball because it is fun.",
        "One day, they went to the park. The park was green. They saw a bird. The bird said, 'Tweet!'",
        "Ben kicked the ball. It went far. Anna ran to get it. 'Good kick!' she said.",
        "They sat on the grass. The grass was soft. They ate apples because they were hungry.",
        "A dog came over. The dog was friendly. They pet the dog. 'Nice dog,' said Ben.",
        "At the end of the day, they went home. 'See you tomorrow,' said Anna to her friend."
      ],
      // Level 4 (DRA ~14-16): 7 passages, building complexity, more descriptive, tricky words like "thought", "through".
      [
        "Jack and his sister Lily wanted to build a fort. They thought it would be fun.",
        "They found old boxes in the garage. The boxes were big. They carried them outside.",
        "Lily said, 'Let's put them here.' They stacked the boxes high. It looked like a house.",
        "Jack went through the door. 'This is cool!' he said. Lily laughed because it was wobbly.",
        "They added a blanket on top. The blanket was soft and blue. Now it was cozy inside.",
        "Their dog Spot came in. Spot wagged his tail. 'You can stay,' said Jack to Spot.",
        "When it was done, they played all day. 'Best fort ever!' thought Lily as they smiled."
      ],
      // Level 5 (DRA ~18-20): 8 passages, fuller story, varied vocabulary, common error words like "where", "were".
      [
        "Sara and her family went on a trip. They were excited to see the ocean for the first time.",
        "They packed bags with clothes and snacks. 'Where is my hat?' asked Sara. Mom found it.",
        "In the car, they sang songs. The road was long, but they were happy. Dad said, 'Almost there!'",
        "At the beach, the sand was warm. Waves crashed on the shore. 'Look at that!' Sara said.",
        "They built a sandcastle. It had towers and a moat. Seagulls flew overhead, calling loudly.",
        "Sara found a shell. It was pink and shiny. 'This is special,' she thought. She kept it.",
        "They swam in the water. It was cool and salty. 'Be careful,' Mom said as they splashed.",
        "As the sun set, they went home. 'What a great day,' said Sara. They were tired but joyful."
      ]
    ];

    const levelNames = [
      "Level 1: Very Easy (DRA ~1-4)",
      "Level 2: Easy (DRA ~6-8)",
      "Level 3: Medium (DRA ~10-12)",
      "Level 4: Challenging (DRA ~14-16)",
      "Level 5: Advanced (DRA ~18-20)"
    ];

    let currentLevel = 0;
    let currentIndex = 0;
    let recognition;
    let isListening = false;
    let finalTranscript = '';
    let interimTranscript = '';

    const levelInfoEl = document.getElementById("level-info");
    const passageEl = document.getElementById("passage");
    const transcriptEl = document.getElementById("transcript");
    const feedbackEl = document.getElementById("feedback");
    const accuracyEl = document.getElementById("accuracy");
    const statusEl = document.getElementById("status");
    const startBtn = document.getElementById("start");
    const stopBtn = document.getElementById("stop");

    // Show current passage
    function loadPassage() {
      if (currentLevel >= levels.length) {
        passageEl.innerHTML = "<strong>Amazing! You've completed all levels! ðŸŽ‰</strong>";
        startBtn.disabled = true;
        return;
      }
      const currentPassages = levels[currentLevel];
      if (currentIndex >= currentPassages.length) {
        statusEl.textContent = "Level complete! Moving to next level... â†‘";
        currentLevel++;
        currentIndex = 0;
        setTimeout(loadPassage, 1800);
        return;
      }
      levelInfoEl.textContent = `${levelNames[currentLevel]} - Passage ${currentIndex + 1} of ${currentPassages.length}`;
      passageEl.textContent = currentPassages[currentIndex];
      transcriptEl.textContent = "";
      feedbackEl.innerHTML = "Word feedback will show here after reading.";
      accuracyEl.textContent = "";
      finalTranscript = '';
      interimTranscript = '';
      statusEl.textContent = "Read this part of the story now...";
    }

    loadPassage();

    // Enhanced accuracy with word-level feedback (simple alignment)
    function getWordFeedback(expected, spoken) {
      const expectedWords = expected.toLowerCase().replace(/[^\w\s]/g, '').split(/\s+/).filter(w => w);
      const spokenWords = spoken.toLowerCase().replace(/[^\w\s]/g, '').split(/\s+/).filter(w => w);

      let feedbackHTML = '';
      let correct = 0;
      let i = 0, j = 0;

      while (i < expectedWords.length || j < spokenWords.length) {
        if (i < expectedWords.length && j < spokenWords.length && expectedWords[i] === spokenWords[j]) {
          feedbackHTML += `<span class="correct">${expectedWords[i]}</span> `;
          correct++;
          i++;
          j++;
        } else if (i < expectedWords.length && (j >= spokenWords.length || (i + 1 < expectedWords.length && expectedWords[i + 1] === spokenWords[j]))) {
          // Missing word in spoken
          feedbackHTML += `<span class="incorrect">${expectedWords[i]}</span> `;
          i++;
        } else if (j < spokenWords.length && (i >= expectedWords.length || (j + 1 < spokenWords.length && expectedWords[i] === spokenWords[j + 1]))) {
          // Extra word in spoken
          feedbackHTML += `<span class="inserted">${spokenWords[j]}</span> `;
          j++;
        } else {
          // Mismatch
          if (i < expectedWords.length) {
            feedbackHTML += `<span class="incorrect">${expectedWords[i]}</span> `;
            i++;
          }
          if (j < spokenWords.length) {
            feedbackHTML += `<span class="inserted">${spokenWords[j]}</span> `;
            j++;
          }
        }
      }

      const accuracy = expectedWords.length > 0 ? Math.round((correct / expectedWords.length) * 100) : 0;
      return { accuracy, feedbackHTML: feedbackHTML.trim() };
    }

    // Web Speech API setup
    if (!('SpeechRecognition' in window) && !('webkitSpeechRecognition' in window)) {
      statusEl.textContent = "Sorry, your browser does not support speech recognition.";
      startBtn.disabled = true;
    } else {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognition = new SpeechRecognition();
      recognition.continuous = true;
      recognition.interimResults = true;
      recognition.lang = 'en-US';

      recognition.onresult = (event) => {
        interimTranscript = '';
        for (let i = event.resultIndex; i < event.results.length; i++) {
          if (event.results[i].isFinal) {
            finalTranscript += event.results[i][0].transcript + ' ';
          } else {
            interimTranscript += event.results[i][0].transcript + ' ';
          }
        }
        transcriptEl.textContent = (finalTranscript + interimTranscript).trim();
      };

      recognition.onerror = (event) => {
        statusEl.textContent = "Error: " + event.error;
        isListening = false;
      };

      recognition.onend = () => {
        if (isListening) {
          recognition.start(); // Auto-restart for continuous listening during pauses
        } else {
          statusEl.textContent = "Stopped listening.";
          // Calculate accuracy on stop (using accumulated transcript)
          const transcript = (finalTranscript + interimTranscript).trim();
          if (transcript) {
            const expected = levels[currentLevel][currentIndex];
            const { accuracy, feedbackHTML } = getWordFeedback(expected, transcript);
            accuracyEl.textContent = `Accuracy: ${accuracy}%`;
            feedbackEl.innerHTML = `<strong>Your reading with feedback:</strong><br>${feedbackHTML}`;
            if (accuracy >= 90) {
              accuracyEl.className = 'success';
              statusEl.textContent = "Great reading! ðŸŽ‰ Moving to next part... â†’";
              currentIndex++;
              setTimeout(loadPassage, 1800);
            } else {
              accuracyEl.className = 'error';
              statusEl.textContent = "Try again! Check the colors for what needs work.";
            }
          }
        }
      };
    }

    startBtn.onclick = () => {
      if (!recognition) return;
      // Clear for new reading attempt
      finalTranscript = '';
      interimTranscript = '';
      transcriptEl.textContent = '';
      accuracyEl.textContent = '';
      feedbackEl.innerHTML = 'Word feedback will show here after reading.';
      isListening = true;
      recognition.start();
      statusEl.textContent = "Listening... Read clearly!";
      startBtn.disabled = true;
      stopBtn.disabled = false;
    };

    stopBtn.onclick = () => {
      isListening = false;
      recognition.stop();
      startBtn.disabled = false;
      stopBtn.disabled = true;
    };

    stopBtn.disabled = true;
  </script>

</body>
</html>
