<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Kids Reading Coach</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 900px; margin: 20px auto; padding: 20px; background: #f9f9f9; }
    h1 { color: #2c3e50; text-align: center; }
    #passage { font-size: 1.4em; line-height: 1.6; background: white; padding: 20px; border: 1px solid #ddd; border-radius: 8px; white-space: pre-wrap; }
    #controls { text-align: center; margin: 20px 0; }
    button { padding: 12px 24px; font-size: 1.1em; margin: 8px; cursor: pointer; border: none; border-radius: 6px; }
    #start { background: #27ae60; color: white; }
    #stop { background: #e74c3c; color: white; }
    #result { font-size: 1.2em; margin: 20px 0; padding: 15px; background: #ecf0f1; border-radius: 8px; min-height: 100px; }
    #accuracy { font-weight: bold; font-size: 1.3em; }
    #status { color: #7f8c8d; }
    .highlight { background: #ffe066; padding: 2px 4px; border-radius: 4px; }
    .success { color: green; }
    .error { color: red; }
  </style>
</head>
<body>
  <h1>Kids Reading Coach</h1>
  <p style="text-align:center;">Read the passage aloud clearly. The app will listen, transcribe, and tell you your accuracy.<br>
  Get <strong>â‰¥ 90%</strong> accuracy on <strong>two passages in a row</strong> to move up!</p>

  <div id="controls">
    <button id="start">Start Listening ðŸŽ¤</button>
    <button id="stop" disabled>Stop Listening</button>
    <select id="levelSelect">
      <option value="0">Level 1 - Very Easy</option>
      <option value="1">Level 2 - Easy</option>
      <option value="2">Level 3 - Medium</option>
    </select>
    <button id="newPassage">New Passage</button>
  </div>

  <div id="passage"></div>

  <div id="result">
    <div id="status">Press "Start Listening" and read the passage above.</div>
    <div id="transcribed"></div>
    <div id="accuracy"></div>
  </div>

  <script>
    // === Passages (make sense, include some repeated/practice words) ===
    const passages = [
      // Level 0 - Very easy (short vowels, simple words)
      "The cat sat on the mat. The cat is fat. Fat cat, fat cat, sit on the mat. The dog can run. Run dog, run!",
      
      // Level 1 - Easy (some blends, repeated words for practice)
      "Sam and Pam like to play. They play all day. Pam has a big red ball. Sam kicks the ball. Kick, kick, kick the red ball! They laugh and play.",
      
      // Level 2 - Medium (longer, introduce trickier words like "through", "enough", repeated for practice)
      "The little bird flew through the sky. It was a beautiful day. The bird sang a happy song. Tweet tweet! Enough rain had fallen. Now the sun shines bright again."
    ];

    // Target practice words per level (will be highlighted)
    const practiceWords = [
      ["cat", "fat", "mat"],           // Level 0
      ["play", "ball", "kick"],        // Level 1
      ["through", "enough", "beautiful"] // Level 2
    ];

    // App state
    let currentLevel = 0;
    let consecutiveSuccess = 0;
    let recognition = null;
    let currentPassageText = "";
    let currentPassageLower = "";

    const startBtn = document.getElementById('start');
    const stopBtn = document.getElementById('stop');
    const passageDiv = document.getElementById('passage');
    const statusDiv = document.getElementById('status');
    const transcribedDiv = document.getElementById('transcribed');
    const accuracyDiv = document.getElementById('accuracy');
    const levelSelect = document.getElementById('levelSelect');
    const newPassageBtn = document.getElementById('newPassage');

    // Check browser support
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SpeechRecognition) {
      statusDiv.innerHTML = '<span class="error">Sorry, your browser does not support Speech Recognition. Try Google Chrome.</span>';
      startBtn.disabled = true;
    } else {
      recognition = new SpeechRecognition();
      recognition.continuous = true;
      recognition.interimResults = true;
      recognition.lang = 'en-US'; // Good for most English accents

      recognition.onresult = (event) => {
        let interim = '';
        let final = '';
        for (let i = event.resultIndex; i < event.results.length; ++i) {
          if (event.results[i].isFinal) {
            final += event.results[i][0].transcript;
          } else {
            interim += event.results[i][0].transcript;
          }
        }
        transcribedDiv.innerHTML = `<strong>You said (live):</strong> ${interim + final}`;
      };

      recognition.onend = () => {
        stopBtn.disabled = true;
        startBtn.disabled = false;
        statusDiv.textContent = "Listening stopped. Calculating accuracy...";
        // Use final transcript for scoring (more accurate than interim)
        const finalTranscript = transcribedDiv.textContent.replace(/You said \(live\): /, '').trim().toLowerCase();
        calculateAccuracy(finalTranscript);
      };

      recognition.onerror = (event) => {
        statusDiv.innerHTML = `<span class="error">Error: ${event.error}</span>`;
        stopBtn.disabled = true;
        startBtn.disabled = false;
      };
    }

    function loadPassage() {
      currentPassageText = passages[currentLevel];
      currentPassageLower = currentPassageText.toLowerCase();

      // Highlight practice words
      let highlighted = currentPassageText;
      practiceWords[currentLevel].forEach(word => {
        const regex = new RegExp(`\\b${word}\\b`, 'gi');
        highlighted = highlighted.replace(regex, `<span class="highlight">${word}</span>`);
      });

      passageDiv.innerHTML = highlighted;
      transcribedDiv.innerHTML = '';
      accuracyDiv.innerHTML = '';
      statusDiv.textContent = `Read this passage aloud. Try the highlighted words!`;
    }

    function calculateAccuracy(transcribedLower) {
      if (!currentPassageLower) return;

      const originalWords = currentPassageLower.split(/\s+/).filter(w => w);
      const spokenWords = transcribedLower.split(/\s+/).filter(w => w);

      // Simple word-level accuracy: % of original words that appear in spoken (order-insensitive bag-of-words match)
      let correct = 0;
      const spokenSet = new Set(spokenWords);
      originalWords.forEach(word => {
        if (spokenSet.has(word)) correct++;
      });

      const accuracy = originalWords.length > 0 ? Math.round((correct / originalWords.length) * 100) : 0;

      accuracyDiv.innerHTML = `Accuracy: <span id="accuracy">${accuracy}%</span>`;

      if (accuracy >= 90) {
        consecutiveSuccess++;
        statusDiv.innerHTML = `<span class="success">Great job! ${accuracy}% correct.</span> Consecutive successes: ${consecutiveSuccess}`;
        if (consecutiveSuccess >= 2 && currentLevel < passages.length - 1) {
          currentLevel++;
          consecutiveSuccess = 0;
          statusDiv.innerHTML += `<br><strong>â†’ Moving up to Level ${currentLevel + 1}!</strong>`;
          levelSelect.value = currentLevel;
          loadPassage();
        }
      } else {
        consecutiveSuccess = 0;
        statusDiv.innerHTML = `<span class="error">Good try! ${accuracy}% â€” let's practice more.</span> Consecutive successes reset.`;
      }
    }

    startBtn.onclick = () => {
      if (!recognition) return;
      transcribedDiv.innerHTML = '';
      recognition.start();
      startBtn.disabled = true;
      stopBtn.disabled = false;
      statusDiv.textContent = "Listening... Read the passage now!";
    };

    stopBtn.onclick = () => {
      if (recognition) recognition.stop();
    };

    levelSelect.onchange = () => {
      currentLevel = parseInt(levelSelect.value);
      consecutiveSuccess = 0; // Reset on manual change
      loadPassage();
    };

    newPassageBtn.onclick = loadPassage;

    // Initial load
    loadPassage();
  </script>
</body>
</html>
